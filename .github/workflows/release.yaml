name: Build and release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Calculate Next Version (Auto-Versioning)
      - name: Bump version and tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          release_branches: main

      - name: Setup Buf
        uses: bufbuild/buf-action@v1
        with:
          setup_only: true

      - name: Generate Code
        run: buf generate

      # ---------------------------------------------------------
      # JAVASCRIPT BUILD & TAG
      # ---------------------------------------------------------
      - name: Prepare JS Package
        env:
          NEW_VERSION: ${{ steps.tag_version.outputs.new_tag }}
        run: |
          cp templates/package.json gen/js/
          cp templates/index.js gen/js/
          cp data/default_alternatives.json gen/js/default_alternatives.json
          
          # Inject Version
          CLEAN_VERSION=${NEW_VERSION#v}
          sed -i "s/0.0.0-PLACEHOLDER/$CLEAN_VERSION/g" gen/js/package.json

      - name: Deploy JS Branch
        uses: s0/git-publish-subdir-action@develop
        env:
          REPO: self
          BRANCH: builds/js
          FOLDER: gen/js
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MESSAGE: "Build ${{ steps.tag_version.outputs.new_tag }}"

      - name: Tag JS Build
        uses: actions/github-script@v7
        with:
          script: |
            // 1. Get the SHA of the NEW head of builds/js
            const ref = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/builds/js'
            });
            const sha = ref.data.object.sha;

            // 2. Create the tag "js-vX.X.X" on that SHA
            const tagName = 'js-${{ steps.tag_version.outputs.new_tag }}';
            try {
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/tags/${tagName}`,
                  sha: sha
                });
            } catch (e) {
                console.log("Tag might already exist or failed:", e);
            }

      # ---------------------------------------------------------
      # DART BUILD & TAG
      # ---------------------------------------------------------
      - name: Prepare Dart Package
        env:
          NEW_VERSION: ${{ steps.tag_version.outputs.new_tag }}
        run: |
          cp templates/pubspec.yaml gen/dart/
          mkdir -p gen/dart/assets
          cp data/default_alternatives.json gen/dart/assets/default_alternatives.json
          
          # Inject Version
          CLEAN_VERSION=${NEW_VERSION#v}
          sed -i "s/0.0.0-PLACEHOLDER/$CLEAN_VERSION/g" gen/dart/pubspec.yaml

      - name: Deploy Dart Branch
        uses: s0/git-publish-subdir-action@develop
        env:
          REPO: self
          BRANCH: builds/dart
          FOLDER: gen/dart
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MESSAGE: "Build ${{ steps.tag_version.outputs.new_tag }}"

      - name: Tag Dart Build
        uses: actions/github-script@v7
        with:
          script: |
            const ref = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/builds/dart'
            });
            const sha = ref.data.object.sha;

            const tagName = 'dart-${{ steps.tag_version.outputs.new_tag }}';
            try {
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/tags/${tagName}`,
                  sha: sha
                });
            } catch (e) {
                console.log("Tag might already exist or failed:", e);
            }

      # ---------------------------------------------------------
      # GITHUB RELEASE (On Main)
      # ---------------------------------------------------------
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_version.outputs.new_tag }}
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          body: ${{ steps.tag_version.outputs.changelog }}